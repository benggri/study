# Service Networking

* Pod 는 Node 에 Host 되지만
* Service 는 Cluster 에 걸쳐 Host 된다
* 특정 Node 에 묶여 있는 건 아니지만 Service 는 Cluster 내에서만 access 가능하다 => Cluster IP

## NodePort

* Pod 집합에서 실행 중인 Application 을 Network Service 로 노출하는 추상화 방법
* [https://kubernetes.io/ko/docs/concepts/services-networking/service/](https://kubernetes.io/ko/docs/concepts/services-networking/service/)

## Service Networking

```
 -------------------          -------------------          -------------------      
|                   |        |                   |        |                   |      
 -------------------          -------------------          -------------------      
 Node1    | 192.168.1.11      Node2    | 192.168.1.12      Node3    | 192.168.1.13  
```

* Pod 나 Service 가 없는 Node Cluster 3개

```
 ---------------- 
| kube-apiserver |---------------------------------------------------------------------            
 ----------------            |                            |                            |           
                    -------------------          -------------------          -------------------  
                   |  ---------        |        |  ---------        |        |  ---------        | 
                   | | kubelet |       |        | | kubelet |       |        | | kubelet |       | 
                   |  ---------        |        |  ---------        |        |  ---------        | 
                   |                   |        |                   |        |                   | 
                    -------------------          -------------------          -------------------  
                    Node1    | 192.168.1.11      Node2    | 192.168.1.12      Node3    | 192.168.1.13  
```

* 각 Node 의 각 Kubelet Service 는 kubeapiserver 를 통해 cluster 의 변화를 지켜본다

```
 ---------------- 
| kube-apiserver |----------------------------------------------------------------------            
 ----------------            |                             |                            |           
                    --------------------          -------------------          -------------------  
                   |  ---------         |        |  ---------        |        |  ---------        | 
                   | | kubelet |        |        | | kubelet |       |        | | kubelet |       | 
                   |  ---------         |        |  ---------        |        |  ---------        | 
                   |                    |        |                   |        |                   | 
                   |  -----             |        |                   |        |                   | 
                   | | Pod | 10.244.1.2 |        |                   |        |                   | 
                   |  -----             |        |                   |        |                   | 
                   |                    |        |                   |        |                   | 
                    --------------------         -------------------          -------------------  
                    Node1    | 192.168.1.11       Node2    | 192.168.1.12      Node3    | 192.168.1.13  
```

* 새 Pod 가 생성될 때마다 CNI Plugin 을 호출해 해당 Pod 에 맞는 Networking 을 구성한다

```
 ---------------- 
| kube-apiserver |----------------------------------------------------------------------            
 ----------------            |                             |                            |           
                    --------------------          --------------------         --------------------- 
                   |  ---------         |        |  ---------         |        |  ---------         | 
                   | | kubelet |        |        | | kubelet |        |        | | kubelet |        | 
                   |  ---------         |        |  ---------         |        |  ---------         | 
                   |                    |        |                    |        |                    | 
                   |  ------------      |        |  ------------      |        |  ------------      | 
                   | | kube-proxy |     |        | | kube-proxy |     |        | | kube-proxy |     | 
                   |  ------------      |        |  ------------      |        |  ------------      | 
                   |                    |        |                    |        |                    | 
                   |  -----             |        |                    |        |                    | 
                   | | Pod | 10.244.1.2 |        |                    |        |                    | 
                   |  -----             |        |                    |        |                    | 
                   |                    |        |                    |        |                    | 
                    --------------------         ---------------------         --------------------- 
                    Node1    | 192.168.1.11       Node2    | 192.168.1.12      Node3    | 192.168.1.13  
```

* 마찬가지로 각 Node 는 kube-proxy 라는 다른 Configuration 요소를 실행한다

```
 ---------------- 
| kube-apiserver |----------------------------------------------------------------------            
 ----------------            |                             |                            |           
                    --------------------          --------------------         --------------------- 
                   |  ---------         |        |  ---------         |        |  ---------         | 
                   | | kubelet |        |        | | kubelet |        |        | | kubelet |        | 
                   |  ---------         |        |  ---------         |        |  ---------         | 
                   |                    |        |                    |        |                    | 
                   |  ------------      |        |  ------------      |        |  ------------      | 
                   | | kube-proxy |     |        | | kube-proxy |     |        | | kube-proxy |     | 
                   |  ------------      |        |  ------------      |        |  ------------      | 
                   |                    |        |                    |        |                    | 
                   |  ---------         |        |                    |        |                    | 
                   | | Service |        |        |                    |        |                    | 
                   |  ---------         |        |                    |        |                    | 
                   |                    |        |                    |        |                    | 
                   |  -----             |        |                    |        |                    | 
                   | | Pod | 10.244.1.2 |        |                    |        |                    | 
                   |  -----             |        |                    |        |                    | 
                   |                    |        |                    |        |                    | 
                    --------------------         ---------------------         --------------------- 
                    Node1    | 192.168.1.11       Node2    | 192.168.1.12      Node3    | 192.168.1.13  
```

* 새 Service 가 생성될 때마다 kube-proxy 가 동작한다

```
 ---------------- 
| kube-apiserver |----------------------------------------------------------------------            
 ----------------            |                             |                            |           
                    --------------------          --------------------         --------------------- 
                   |  ---------         |        |  ---------         |        |  ---------         | 
                   | | kubelet |        |        | | kubelet |        |        | | kubelet |        | 
                   |  ---------         |        |  ---------         |        |  ---------         | 
                   |                    |        |                    |        |                    | 
                   |  ------------      |        |  ------------      |        |  ------------      | 
                   | | kube-proxy |     |        | | kube-proxy |     |        | | kube-proxy |     | 
                   |  ------------      |        |  ------------      |        |  ------------      | 
                   |                    |        |                    |        |                    | 
                 ---------------------------------------------------------------------------------------
                |                                      Service                                          | 
                 ---------------------------------------------------------------------------------------
                   |                    |        |                    |        |                    | 
                   |  -----             |        |                    |        |                    | 
                   | | Pod | 10.244.1.2 |        |                    |        |                    | 
                   |  -----             |        |                    |        |                    | 
                   |                    |        |                    |        |                    | 
                    --------------------         ---------------------         --------------------- 
                    Node1    | 192.168.1.11       Node2    | 192.168.1.12      Node3    | 192.168.1.13  
```

* Pod 와 달리 Service 는 각 Node 에서 생성되거나 각 Node 에 할당되지 않는다
* Service 는 Cluster 전체 개념이다
* Cluster 의 모든 Node 에 걸쳐 존재한다
* 사실, Service 는 존재하는 것이 아니다
* Service 의 IP 에서 수신되는 Server 나 Service 가 없다

* Pod 에 Container 와 Container 가 있는데 Interface 에 할당된 namespace 가 있다
* 그런데 Service 는 없다
* process 나 namespace interface 도 없다
* 즉, 가상 객체이다

## 그럼 IP Address 는 어떻게 확보하고 Service 를 통해 Pod 에서 응용프로그램에 어떻게 접근할까?

* Kubernetes 에서 Service 객체를 생성하면 미리 정의된 범위에서 IP Address 를 할당한다

```
 ---------------- 
| kube-apiserver |-------------------------------------------------------------------------              
 ----------------            |                              |                              |            
                    ---------------------------    ---------------------------   ---------------------  
                   |  ---------                |  |  ---------                |  |  ---------         | 
                   | | kubelet |               |  | | kubelet |               |  | | kubelet |        | 
                   |  ---------                |  |  ---------                |  |  ---------         | 
                   |                           |  |                           |  |                    | 
                   |  ------------             |  |  ------------             |  |  ------------      | 
                   | | kube-proxy |            |  | | kube-proxy |            |  | | kube-proxy |     | 
                   |  ------------             |  |  ------------             |  |  ------------      | 
                   |                           |  |                           |  |                    | 
                 ----------------------------------------------------------------------------------------
                |                                      Service                                           | 
                 ----------------------------------------------------------------------------------------
                   |                           |  |                           |  |                    | 
                   |  -----                    |  |                           |  |                    | 
                   | | Pod | 10.244.1.2        |  |                           |  |                    | 
                   |  -----                    |  |                           |  |                    | 
                   |                           |  |                           |  |                    | 
                    ---------------------------    ---------------------------    --------------------  
                   | IP Address   | Forward To |  | IP Address   | Forward To |  |         |          | 
                    ---------------------------    ---------------------------    --------------------  
                   | 10.99.13.178 | 10.244.1.2 |  | 10.99.13.178 | 10.244.1.2 |  |         |          | 
                    ---------------------------    ---------------------------    --------------------- 
                    Node1    | 192.168.1.11        Node2    | 192.168.1.12        Node3    | 192.168.1.13  
```

* 하지만 IP Address 를 할당하면 각 Node 에서 실행 중이 kube-proxy 는 해당 IP Address 를 받아 Cluster 내 각 Node 에 전달 규칙을 만든다
* 이 IP 로 오는 Traffic 은 Service IP 의 Pod 의 IP 로 전달하도록
* Pod 가 Service IP 에 도달하려고 할 때 마다 Pod 의 IP Address 로 전달된다
* Cluster 의 어떤 노드에서도 Access 가 가능하다



```
 ---------------- 
| kube-apiserver |------------------------------------------------------------------------------------              
 ----------------            |                                         |                              |            
                    ------------------------------    ------------------------------   ---------------------  
                   |  ---------                   |  |  ---------                   |  |  ---------         | 
                   | | kubelet |                  |  | | kubelet |                  |  | | kubelet |        | 
                   |  ---------                   |  |  ---------                   |  |  ---------         | 
                   |                              |  |                              |  |                    | 
                   |  ------------                |  |  ------------                |  |  ------------      | 
                   | | kube-proxy |               |  | | kube-proxy |               |  | | kube-proxy |     | 
                   |  ------------                |  |  ------------                |  |  ------------      | 
                   |                              |  |                              |  |                    | 
                 ----------------------------------------------------------------------------------------------
                |                                         Service                                              | 
                 ----------------------------------------------------------------------------------------------
                   |                              |  |                              |  |                    | 
                   |  -----                       |  |                              |  |                    | 
                   | | Pod | 10.244.1.2           |  |                              |  |                    | 
                   |  -----                       |  |                              |  |                    | 
                   |                              |  |                              |  |                    | 
                    ------------------------------    ------------------------------    --------------------  
                   | IP Address      | Forward To |  | IP Address      | Forward To |  |         |          | 
                    ------------------------------    ------------------------------    --------------------  
                   | 10.99.13.178:80 | 10.244.1.2 |  | 10.99.13.178:80 | 10.244.1.2 |  |         |          | 
                    ------------------------------    ------------------------------    --------------------- 
                    Node1            | 192.168.1.11   Node2            | 192.168.1.12   Node3    | 192.168.1.13  
```

* Port 조합
* Service 가 생성되거나 삭제될 때 마다 kube-proxy 가 이런 규칙을 생성하거나 삭제한다


## kube-proxy

* kube-proxy 는 다양한 방법을 지원한다
  * userspace
  * ipvs
  * iptables
* proxy mode 는 kube-proxy service 를 구성하는 동안 proxy mode option 을 이용해 설정할 수 있다
* 기본 값은 iptables

```bash
kube-proxy --proxy-mode [userspace | iptables | ipvs]...
```

## kube-proxy 로 iptables 가 어떻게 구성는지 Node 에서 어떻게 볼 수 있을까?

* Pod

```bash
kubectl get pod -o wide

NAME READY STATUS  RESTARTS AGE  IP         NODE
db   1/1   Running 0        14h  10.244.1.2 node-1
```

* Cluster IP Service 를 생성해 Cluster 안에서 이 Pod 가 사용 가능하도록 한다

```bash
kubectl get service

NAME       TYPE      CLUSTER-IP     PORT(S)  AGE
db-service ClusterIP 10.103.132.104 3306/TCP 12h
```

* Service 가 생성되면 kubernetes 는 IP 주소를 할당한다
* Service Cluster IP Range 는 kube-api-server option 에 지정되어있다

```bash
kube-api-server --service-cluster-ip-range ipNet
```

```bash
ps -ef | grep kube-apiserver
kube-apiserver --authorizati~~
...
--service-cluster-ip-range=10.96.0.0/12
...
```

```
10.96.0.0 => 10.111.255.255
```

* Pod 와 Service 가 같은 IP Address 를 할당받는 경우가 있어선 안된다

```
iptables -L -t nat | gerp db-service

# 주석으로 적혀있다
/* db-service: ~~ */ 
```

* type nodePort 의 Service 를 만들 때 kube-proxy 는 iptables 에 규칙을 만들어 모든 Node 의 Port 로 들어오는 Traffic 을 각각의 Backend 로 전달한다
* kube-proxy 가 항목을 생성하는 걸 kube-proxy.log 에서 확인할 수 있다

```bash
/var/log/kube-proxy.log
```

* 일반적으로 Cluster 의 모든 단일 Node 에 배포할 때 사용하는 방법론은 Daemonset 이다

```bash
kubeclt get all --all-namespaces
# kube-proxy 와 관련된 항목을 찾는다

# daemonset.app/kube-proxy 가 있는 것을 확인할 수 있다
```