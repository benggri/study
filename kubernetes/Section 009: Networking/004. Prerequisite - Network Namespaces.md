# Prerequisite - Network Namespaces

* Network 격리를 위해 Docker 같은 Container 가 사용한다
* Netwrok 가 집이라면 Network Namespaces 방으로 생각하면 편하다

# Host

* Networking 관해 Host 는 Interface 를 가지고 있다 
* 고유의 라우팅과 ARP 테이블이 있다

```
 -----------------------------  
|                             | 
|                             | 
|                             | 
 -----------------------------  
| Routing Table | | ARP Table | 
 ---------------   -----------  
```

* Container 가 생성되면?

```
 -------------------------------------------------
|                                                 |
|         -----------------------------           |
|        |                             |          |
|        |          Container          |          |
|        |                             |          |
|         -----------------------------           |
|        | Routing Table | | ARP Table |          |
|         ---------------   -----------           |
|                                                 |
 -------------------------------------------------
|      Routing Table      | |      ARP Table      | 
 -------------------------   ---------------------  
```

* Container 는 고유의 가상 인터페이스 Routing, ARP 테이블을 가질 수 있다
* Container 는 고유의 인터페이스를 가진다

## Network Namepsace

### 생성

```bash
ip netns add {network_namespace_name}
```

### 연결

```bash
ip netns exec {network_namespace_name} ip link
ip -n {network_namespace_name} ip link
```

### 두개의 Container 를 서로 연결하기

```
 -------------------  
|                   | 
|  -----    ------  | 
| |     |  |      | | 
| | Red |  | Blue | | 
| |     |  |      | | 
|  -----    ------  | 
|                   | 
 -------------------  
```

```bash
ip link add veth-red type veth peer name veth-blue
```

```
 ---------------------------------  
|                                 | 
|  --------             --------  | 
| |        |           |        | | 
| |  Red   |           |  Blue  | | 
| |        |           |        | | 
|  --------             --------  | 
|                                 | 
|  --------             --------  | 
| |veth-red|-----------|veth-red| | 
|  --------             --------  | 
 ---------------------------------  
```

```bash
ip link set veth-red netns red
ip link set veth-blue netns blue
```

```
 -----------------------------------------  
|                                         | 
|  --------                     --------  | 
| |        |                   |        | | 
| |       --------      --------        | | 
| |  Red |veth-red|----|veth-red| Blue  | | 
| |       --------      --------        | | 
| |        |                   |        | | 
|  --------                     --------  | 
|                                         | 
 -----------------------------------------  
```

* IP 주소를 할당

```bash
ip -n red addr add 192.168.15.1 dev weth-red
ip -n blue addr add 192.168.15.2 dev weth-blue

ip -n red link set veth-red up
ip -n blue link set veth-blue up

# red
ip netns exec red ping 192.168.15.2
=> ping 
ip netns exec red arp
=> ARP 테이블 확인

# blue
ip netns exec blue ping 192.168.15.1
=> ping 
ip netns exec blue arp
=> ARP 테이블 확인
```

* 가상 네트워크를 생성하기 위해서 가상 스위치가 필요하다

## Linux Bridge

```bash
ip link add v-net-0 type bridge # 생성
ip link # 확인해보면 v-net-0 은 state DOWN
ip link set dev v-net-0 up # 실행
```

```
 -------------------------------  
|  ---                     ---  | 
| | A |                   | B | | 
|  ---                     ---  | 
|       -----------------       | 
|      |     Network     |      | 
|      |     v-net-0     |      | 
|      |  198.168.15.0   |      | 
|       -----------------       | 
|  ---                     ---  | 
| | C |                   | D | | 
|  ---                     ---  | 
 -------------------------------  
```

```bash
ip link add veth-a type veth peer name veth-a-br
```

```
                           -------------------------------  
                          |  ---                     ---  | 
                          | | A |                   | B | | 
                          |  ---                     ---  | 
 --------    -----------  |       -----------------       | 
| weth-a |--| veth-a-br | |      |     Network     |      | 
 --------    -----------  |      |     v-net-0     |      | 
                          |      |  198.168.15.0   |      | 
                          |       -----------------       | 
                          |  ---                     ---  | 
                          | | C |                   | D | | 
                          |  ---                     ---  | 
                           -------------------------------  
```

```bash
ip link set veth-a netns a
ip link set veth-a-br master v-net-0
```

```
 ---------------------------------------------  
|  ---  --------                         ---  | 
| | A || weth-a |-----                  | B | | 
|  ---  --------      |                  ---  | 
|        -----------  |                       | 
|       | veth-a-br |-                        | 
|        ----------- -----------              | 
|             |     Network     |             | 
|             |     v-net-0     |             | 
|             |  198.168.15.0   |             | 
|              -----------------              | 
|  ---                                   ---  | 
| | C |                                 | D | | 
|  ---                                   ---  | 
 ---------------------------------------------  
```

```bash
# IP 주소 할당
ip -n a addr add 192.168.15.1 dev veth-a
ip -n a link set veth-a up
```

```bash
ping 192.168.15.1
=> 실패
```

```bash
ip addr add 192.168.15.5/24 dev v-net-0
```

```
 ---------------------------------------------  
|  ---  --------                         ---  | 
| | A || weth-a |-----                  | B | | 
|  ---  --------      |                  ---  | 
|        -----------  |                       | 
|       | veth-a-br |-                        | 
|        ----------- -----------              | 
|             |     Network     |             | 
|             |     v-net-0     |             | 
|             |  198.168.15.0   |             | 
|             |  198.168.15.5   |             | 
|              -----------------              | 
|  ---                                   ---  | 
| | C |                                 | D | | 
|  ---                                   ---  | 
 ---------------------------------------------  
```

```bash
ping 192.168.15.1
=> 성공
```

* 여기까지가 이더넷에 대한 설정
* 외부로 나갈려면 어떻게 해야하지?
* iptable 을 사용하면 된다

```bash
iptables -t nat -A POSTROUTING -s 192.168.15.0/24 -j MASQUERADE
```

```
 ------------------------------           ------------           
|  ---                    ---  |         |             |         
| | A |                  | B | |         |             |         
|  ---                    ---  |         |  GATEWAY    |         
|        -----------------     |         |  NAT        |            -------------
|       |     Network     |   ------------           ----------    | LAN         |
|       |  198.168.15.0   |  | v-net-0    |         | eth0     |---| 192.168.1.0 |       
|        -----------------    ------------           ----------    |             |
|                             192.168.15.5          192.168.1.2     -------------
|  ---                    ---  |         |             |         
| | C |                  | D | |         |             |         
|  ---                    ---  |         |             |         
 ------------------------------           ------------           
```

* 이제 B => C 로 ping 이 된다
* LAN 이 Internet 에 연결됐으면...?

```
 ------------------------------           ------------               ------------
|  ---                    ---  |         |             |            | Internet   |
| | A |                  | B | |         |             |            -------------
|  ---                    ---  |         |  GATEWAY    |                  |
|        -----------------     |         |  NAT        |            -------------
|       |     Network     |   ------------           ----------    | LAN         |
|       |  198.168.15.0   |  | v-net-0    |         | eth0     |---| 192.168.1.0 |       
|        -----------------    ------------           ----------    |             |
|                             192.168.15.5          192.168.1.2     -------------
|  ---                    ---  |         |             |         
| | C |                  | D | |         |             |         
|  ---                    ---  |         |             |         
 ------------------------------           ------------           
```

* Namespace 가 Internet 에 도달해야한다

```bash
ip netns exec b ping 8.8.8.8
```

* 안됨 ㅋ

```bash
ip netns exec b route
```

```bash
ip netns exec b ip route add default via 192.168.15.5
```

```bash
ip netns exec b ping 8.8.8.8
```

* 이제 됨


```
                            ----------------------------------------------------------------
                           |                                                                |
 --------------------------|---           ------------               ------------     ------|------
|  ---                    ---  |         |             |            | Internet   |   |             | 
| | A |                  | B | |         |             |            -------------    |   Another   | 
|  ---                    ---  |         |  GATEWAY    |                  |          |             | 
|        -----------------     |         |  NAT        |            -------------    |             | 
|       |     Network     |   ------------           ----------    | LAN         |   |             | 
|       |  198.168.15.0   |  | v-net-0    |         | eth0     |---| 192.168.1.0 |   |             | 
|        -----------------    ------------           ----------    |             |   |             | 
|                             192.168.15.5          192.168.1.2     -------------    |             | 
|  ---                    ---  |         |             |                             |             | 
| | C |                  | D | |         |             |                             |             | 
|  ---                    ---  |         |             |                             | 192.168.1.3 | 
 ------------------------------           ------------                                -------------
                                                                                     ping 192.168.15.2 => 안됨
```

* Another 에서 B 로 ping 은 되지 않는다
* 지금까지 만든 사설 Network 를 모르기 때문이다
* Another 와 사설 Network 를 연결하기 위해서는 두 가지 옵션이 있다
  * 사설 Network 의 정보를 Another 에 넘기는 것
  * iptable 에 port 전달 역할을 추가한다

```bash
# 80 Port 로 오면 192.168.15.2:80 으로 전달
iptables -t nat -A PREROUTING --dport 80 --to-destination 192.168.15.2:80 -j DNAT
```