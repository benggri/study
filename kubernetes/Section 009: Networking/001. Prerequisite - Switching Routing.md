# Prerequisite - Switching Routing

## Linux Networking Basics

### Nerworking Pre-Requistites(사전 전제조건)

* Switching and Routing
  * Switching
  * Routing
  * Default Gateway
* DNS
  * DNS Configurations on Linux
  * CoreDNS Introduction
* Nerwork Namespaces
* Docker Networking

### Switching

```

 -----------    ------------  
|           |  |            | 
|     A     |  |     B      | 
| (Desktop) |  | (Cloud VM) | 
|           |  |            | 
 -----------    ------------  

```

* A 와 B 를 연결하려먼?

```

 ---------------                       --------------  
|               |                     |              | 
|       A       |   ---------------   |      B       | 
|   (Desktop)   |  |     Switch    |  |  (Cloud VM)  | 
|               |   ---------------   |              | 
|               |  |  192.168.1.0  |  |              | 
|               |   ---------------   |              | 
 ---------------                       --------------  
| 192.168.1.10 |                      | 192.168.1.11 |
 ---------------                       --------------  

```

* Switch 는 두 시스템을 포함하는 네트워크를 만든다

```

 ---------------                                           --------------  
|               |                                         |              | 
|       A       |             ---------------             |      B       | 
|   (Desktop)   |------------|     Switch    |------------|  (Cloud VM)  | 
|               |             ---------------             |              | 
|               |            |  192.168.1.0  |            |              | 
|               |             ---------------             |              | 
 ---------------                                           --------------  
| 192.168.1.10 |                                          | 192.168.1.11 |
 ---------------                                           --------------  
ip link                                                   ip link
  => eth0:                                                  => eth0:
ip addr add 192.168.1.10/24 dev eth0                      ip addr add 192.168.1.11/24 dev eth0 

```

```bash
# ip addr add 명령어는 재부팅이 되면 변경 사항을 저장하지 않는다

# 재부팅 후에도 해당 설정을 유지를 하고 싶다면
/etc/network/interfaces
# 파일에 설정해야한다
```

* Switch 는 Network 내에서만 통신을 가능하게한다
* Network 상의 Host 로부터 packet 을 받아 같은 Network 내 다른 시스템으로 전달할 수 있다

### Routing

* 두개의 Network 를 연결하려면?

```

 ------------                   ------------       ------------                   ------------  
|            |   -----------   |            |     |            |   -----------   |            | 
|     A      |--|   Switch  |--|     B      |     |     C      |--|   Switch  |--|     D      | 
|            |   -----------   |            |     |            |   -----------   |            | 
|            |  |192.168.1.0|  |            |     |            |  |192.168.2.0|  |            | 
|            |   -----------   |            |     |            |   -----------   |            | 
 ------------                   ------------       ------------                   ------------  
|192.168.1.10|                 |192.168.1.11|     |192.168.2.10|                 |192.168.2.11| 
 ------------                   ------------       ------------                   ------------                           

```

* Router 는 두 Network 를 연결한다

```

 ------------                   ------------       ------------                   ------------  
|            |   -----------   |            |     |            |   -----------   |            | 
|     A      |--|   Switch  |--|     B      |     |     C      |--|   Switch  |--|     D      | 
|            |   -----------   |            |     |            |   -----------   |            | 
|            |  |192.168.1.0|  |            |     |            |  |192.168.2.0|  |            | 
|            |   -----------   |            |     |            |   -----------   |            | 
 ------------         |         ------------       ------------         |         ------------  
|192.168.1.10|        |        |192.168.1.11|     |192.168.2.10|        |        |192.168.2.11| 
 ------------         |         ------------       ------------         |         ------------  
                      |                                                 |                                                 
                      |                    --------                     |                                       
                       -------------------| Router |--------------------
                          192.168.1.1      --------     192.168.2.1
```

```bash
route

# B 
ip route add 192.168.2.0/24 via 192.168.1.1

# C
ip route add 192.168.1.0/24 via 192.168.2.1
```

```

 ------------                   ------------       ------------                   ------------  
|            |   -----------   |            |     |            |   -----------   |            | 
|     A      |--|   Switch  |--|     B      |     |     C      |--|   Switch  |--|     D      | 
|            |   -----------   |            |     |            |   -----------   |            | 
|            |  |192.168.1.0|  |            |     |            |  |192.168.2.0|  |            | 
|            |   -----------   |            |     |            |   -----------   |            | 
 ------------         |         ------------       ------------         |         ------------  
|192.168.1.10|        |        |192.168.1.11|     |192.168.2.10|        |        |192.168.2.11| 
 ------------         |         ------------       ------------         |         ------------  
                      |                                                 |                                                 
                      |                    --------                     |                                       
                       -------------------| Router |--------------------
                          192.168.1.1      --------     192.168.2.1
                                               |
                                               |
                                        ---------------  
                                       |   Internet    | 
                                        ---------------  
                                       | 172.217.194.0 | 
                                        ---------------  
```

```bash
route

ip route add 172.217.194.0/24 via 192.168.2.1
```


```

 ------------                   ------------       ------------                   ------------  
|            |   -----------   |            |     |            |   -----------   |            | 
|     A      |--|   Switch  |--|     B      |     |     C      |--|   Switch  |--|     D      | 
|            |   -----------   |            |     |            |   -----------   |            | 
|            |  |192.168.1.0|  |            |     |            |  |192.168.2.0|  |            | 
|            |   -----------   |            |     |            |   -----------   |            | 
 ------------         |         ------------       ------------         |         ------------  
|192.168.1.10|        |        |192.168.1.11|     |192.168.2.10|        |        |192.168.2.11| 
 ------------         |         ------------       ------------         |         ------------  
                      |                                                 |                                                 
                      |                    --------                     |                                       
                       -------------------| Router |--------------------
                          192.168.1.1      --------     192.168.2.1
                                               |
                                               |
                                        ---------------   ---------------   ---------------   ---------------  
                                       |   Internet    | |   Internet    | |   Internet    | |   Internet    | 
                                        ---------------   ---------------   ---------------   ---------------  
                                       | 172.217.194.0 | | nnn.nnn.nnn.n | | nnn.nnn.nnn.n | | nnn.nnn.nnn.n | 
                                        ---------------   ---------------   ---------------   ---------------  
```

```bash
route

ip route add default via 192.168.2.1
```

#### Linux Host 를 Router 로 설정

```
       ---------------------------------- ? ----------------------------------
      |                                                                       |
 -----------                         -----------                         ----------- 
|     A     |                ----   |     B     |   ----                |     C     |
 ----------- --192.168.1.0--|eth0|-- ----------- --|eth1|--192.168.1.0-- ----------- 
|192.168.1.5|                ----   |           |   ----                |192.168.2.5|
 -----------                         -----------                         ----------- 
                         198.168.1.6             192.168.2.6
```

* B 가 Router 역할이 된다

```bash
# A
ip route add 192.168.2.0/24 via 192.168.1.6

# C
ip route add 192.168.1.0/24 via 192.168.2.6
```


* 기본적으로 Linux 에서 packet 은 한 인터페이스에서 다음 인터페이스로 전달되지 않는다

```
       ---------------------------------- ? ----------------------------------
      |                                                                       |
 -----------                         -----------                         ----------- 
|     A     |                ----   |     B     |   ----                |     C     |
 ----------- --192.168.1.0--|eth0|-- ----------- --|eth1|--192.168.1.0-- ----------- 
|192.168.1.5|                ----   |           |   ----                |192.168.2.5|
 -----------                         -----------                         ----------- 
                         198.168.1.6             192.168.2.6
```

```bash
cat /proc/sys/net/ipv4/ip_forward
0

echo 1 > /proc/sys/net/ipv4/ip_forward
1

# 재부팅 후에도 계속 적용을 위해서 설정 파일 변경
/etc/sysctl.conf
...
net.ipv4.ip_forward = 1
...
```