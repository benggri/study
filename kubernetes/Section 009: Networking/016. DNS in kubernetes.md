# DNS in kubernetes

* DNS
* Host/NS Lookup, Dig utility
* Recorded Types - A, CNAME
* Domain Name Hierarchy

``` 
             -----------------------    -----------------------    -----------------------   
            |                       |  |                       |  |                       |  
            |       ---------       |  |       ---------       |  |       ---------       |  
            |      | Service |      |  |      | Service |      |  |      | Service |      |  
            |       ---------       |  |       ---------       |  |       ---------       |  
            |                       |  |                       |  |                       |  
            |     -----    -----    |  |     -----    -----    |  |     -----    -----    |  
            |    | Pod |  | Pod |   |  |    | Pod |  | Pod |   |  |    | Pod |  | Pod |   |  
            |     -----    -----    |  |     -----    -----    |  |     -----    -----    |  
            |                       |  |                       |  |                       |  
             -----------------------    -----------------------    -----------------------   
            | node1.kubecluster.org |  | node1.kubecluster.org |  | node1.kubecluster.org |  
            | 192.168.1.11          |  | 192.168.1.12          |  | 192.168.1.13          |
             -----------------------    -----------------------    -----------------------   
 -----                |                          |                          |                
| DNS |---------------------------------------------------------------------                 
 -----  
```

## kube DNS

``` 
             -----------------------    -----------------------    -----------------------    
            |                       |  |                       |  |                       |   
           ---------------------------------------------------------------------------------  
          |                                                                                 | 
          |                                    kube DNS                                     | 
          |                                                                                 | 
           ---------------------------------------------------------------------------------  
            |                       |  |                       |  |                       |   
            |       ---------       |  |       ---------       |  |       ---------       |   
            |      | Service |      |  |      | Service |      |  |      | Service |      |   
            |       ---------       |  |       ---------       |  |       ---------       |   
            |                       |  |                       |  |                       |   
            |     -----    -----    |  |     -----    -----    |  |     -----    -----    |   
            |    | Pod |  | Pod |   |  |    | Pod |  | Pod |   |  |    | Pod |  | Pod |   |   
            |     -----    -----    |  |     -----    -----    |  |     -----    -----    |   
            |                       |  |                       |  |                       |   
             -----------------------    -----------------------    -----------------------    
            | node1.kubecluster.org |  | node1.kubecluster.org |  | node1.kubecluster.org |   
            | 192.168.1.11          |  | 192.168.1.12          |  | 192.168.1.13          |   
             -----------------------    -----------------------    -----------------------    
 -----                |                          |                          |                
| DNS |---------------------------------------------------------------------                 
 -----  
```

* Kubernetes 는 cluster 를 설정할 때 기본 탑재된 DNS Server 를 배포한다
* Kubernetes 를 수동으로 설정하면 직접 할 수 있다

## Cluster 내 Pod 와 Service 에서 kube DNS 

* Cluster 의 Networking 설정이 올바르다면 모든 Pod 및 Service 가 각자의 IP Address 를 얻어 서로 통신할 수 있다면 문제 없을 것이다

```
 -----------------------------------------  
|                                         | 
|                 kube DNS                | 
|                                         | 
 -----------------------------------------  
       ---------          ---------         
      | Service |        | Service |        
       ---------          ---------         
     -----    -----     -----    -----      
    | Pod |  | Pod |   | Pod |  | Pod |     
     -----    -----     -----    -----      
```

```
 ----------------------------------------------  
|                                              | 
|                   kube DNS                   | 
|                                              | 
 ----------------------------------------------  
 -----------    ---------------    ------------  
|  Pod      |  |    Service    |  |     Pod    | 
 -----------    ---------------    ------------  
| 10.244.1.5|  | 10.107.37.188 |  | 10.244.2.5 | 
| test      |  | web-service   |  | web        | 
 -----------    ---------------    ------------  
```

* 같은 namespace 안에 있다는 가정
* DNS 와 관련해서 모든 Pod 와 Service 가 IP Address 로 서로 통신할 수 있다고 가정
* web(Pod) 가 test(Pod) 에 Access 할 수 있게 하려면 Service 를 만들어야한다 => web-service
* kube DNS 는 Service 가 생성될 때마다 기록을 남긴다

```
 ----------------------------------------------  
|                                              | 
|                   kube DNS                   | 
|                                              | 
 ----------------------------------------------  
| hostname             | IP Address            | 
 ----------------------------------------------  
| web-service          | 10.107.37.188         | 
 ----------------------------------------------  
 -----------    ---------------    ------------  
|  Pod      |  |    Service    |  |     Pod    | 
 -----------    ---------------    ------------  
| 10.244.1.5|  | 10.107.37.188 |  | 10.244.2.5 | 
| test      |  | web-service   |  | web        | 
 -----------    ---------------    ------------  
```

* Service 이름을 IP Address 에 매핑한다
* Cluster 내 어떤 Pod 도 Service 이름을 사용해 이 Service 에 도달할 수 있다

```bash
# test => web-service
curl http://web-service
```

* 만약 다른 namespace 일 경우 namespace 까지 작성해야한다

```
 ---------------------------------------------------------------  
|                                                               | 
|                           kube DNS                            | 
|                                                               | 
 ---------------------------------------------------------------  
| hostname                     | IP Address                     | 
 ---------------------------------------------------------------  
| web-service                  | 10.107.37.188                  | 
 ---------------------------------------------------------------  

 -------------------     --------------------------------------- 
| default           |   | apps                                  | # namespace
 -------------------     --------------------------------------- 
|                   |   |                                       | 
|    -----------    |   |    ---------------    ------------    | 
|   |  Pod      |   |   |   |    Service    |  |     Pod    |   | 
|    -----------    |   |    ---------------    ------------    | 
|   | 10.244.1.5|   |   |   | 10.107.37.188 |  | 10.244.2.5 |   | 
|   | test      |   |   |   | web-service   |  | web        |   | 
|    -----------    |   |    ---------------    ------------    | 
 -------------------     ---------------------------------------  
```

```bash
# test => web-service
curl http://web-service.apps
#           servicename.namespace
```

* kube DNS 는 각 namespace 에 하위 도메인을 생성한다
* 모든 service 는 SVC 라는 다른 하위 도메인으로 함께 묶인다

```
 ---------------------------------------------------------------  
|                                                               | 
|                           kube DNS                            | 
|                                                               | 
 ---------------------------------------------------------------  
| hostname    | Namespace       | IP Address                     | 
 ---------------------------------------------------------------  
| web-service | apps            | 10.107.37.188                  | 
 ---------------------------------------------------------------  

 ---------------------------------------   -------------  
| apps                                  | |     apps    | # namespace
 ---------------------------------------   -------------  
|                                       |         |       
|    ---------------    ------------    |  -------------  
|   |    Service    |  |     Pod    |   | | web-service | # service 
|    ---------------    ------------    |  -------------  
|   | 10.107.37.188 |  | 10.244.2.5 |   | 
|   | web-service   |  | web        |   | 
|    ---------------    ------------    | 
 ---------------------------------------  
```

* 각 namesapce 에 대해 DNS 는 namespace 의 이름으로 하위 도메인을 만든다
* namespace 의 모든 pod 와 service 는 하위 도메인으로 함께 분류된다

```
 ---------------------------------------------------------------  
|                                                               | 
|                           kube DNS                            | 
|                                                               | 
 ---------------------------------------------------------------  
| hostname    | Namespace | Type     | IP Address               | 
 ---------------------------------------------------------------  
| web-service | apps      | SVC      | 10.107.37.188            | 
 ---------------------------------------------------------------  

                                           -------------  
                                          |     svc     | 
                                           -------------  
                                                 |        
 ---------------------------------------   -------------  
| apps                                  | |     apps    | # namespace
 ---------------------------------------   -------------  
|                                       |        |        
|    ---------------    ------------    |  -------------  
|   |    Service    |  |     Pod    |   | | web-service | # service 
|    ---------------    ------------    |  -------------  
|   | 10.107.37.188 |  | 10.244.2.5 |   | 
|   | web-service   |  | web        |   | 
|    ---------------    ------------    | 
 ---------------------------------------  
```

* 모든 Service 는 SVC 라는 또 다른 하위 도메인으로 함꼐 그룹화된다

```bash
# test => web-service
curl http://web-service.apps.svc
#           servicename.namespace.type
```

* 모든 Service 와 Pod 는 함께 분류된다
* Cluster Route 도메인으로 설정되며 local 이 기본값

```
 ----------------------------------------------------------------  
|                                                                | 
|                            kube DNS                            | 
|                                                                | 
 ----------------------------------------------------------------  
| hostname    | Namespace | Type | Root          | IP Address    | 
 ----------------------------------------------------------------  
| web-service | apps      | SVC  | cluster.local | 10.107.37.188 | 
 ----------------------------------------------------------------  

                                           ---------------  
                                          | cluster.local | 
                                           ---------------
                                                  |        
                                           ---------------  
                                          |      svc      | 
                                           ---------------  
                                                  |        
 ---------------------------------------   ---------------  
| apps                                  | |      apps     | # namespace
 ---------------------------------------   ---------------  
|                                       |         |        
|    ---------------    ------------    |  ---------------  
|   |    Service    |  |     Pod    |   | |  web-service  | # service 
|    ---------------    ------------    |  ---------------  
|   | 10.107.37.188 |  | 10.244.2.5 |   | 
|   | web-service   |  | web        |   | 
|    ---------------    ------------    | 
 ---------------------------------------  
```

```bash
# test => web-service
curl http://web-service.apps.svc.cluster.local
#           servicename.namespace.type.root
```

* Pod 는 기본값으로 생성되지 않지만 명시적으로 실행할 수 있다
* 과거에는 Pod 도 생성되었지만 Service 와 다르게 Hostname 을 사용하지 않고 IP 의 "." 을 "-" 로 치환하여 생성되었다 

```
 ----------------------------------------------------------------  
|                                                                | 
|                            kube DNS                            | 
|                                                                | 
 ----------------------------------------------------------------  
| hostname    | Namespace | Type | Root          | IP Address    | 
 ----------------------------------------------------------------  
| 10-244-2-5  | apps      | pod  | cluster.local | 10.244.2.5    | 
 ----------------------------------------------------------------  
```