# ETCD in HA

* What is ETCD?
* What is a Key-Value Store?
* How to get started quickly?
* How to operate ETCD?
* What is a distributed system?
* How ETCD Operates
* RAFT Protocol
* Best practices on number of nodes

## What is ETCD?

* A distributed, reliable key-value store for the most critical data of a distributed system
* 분산 시스템의 가장 중요한 데이터를 위한 분산되고, 안정적인 key-value 저장소
* [https://etcd.io/](https://etcd.io/)

## What is a Key-Value Store?

* Table 이 아닌 Document 나 Page 로 데이터를 저장한다

```
# Table
 -------------------
| Name        | Age | 
|-------------------| 
| John Doe    | 45  | 
|-------------------| 
| Dave Smith  | 34  | 
|-------------------| 
| Lily Oliver | 55  | 
 ------------------- 
# key-value

 -----------------   -------------------   --------------------  
| key  | value    | | key  | value      | | key  | value       | 
 -----------------   -------------------   --------------------  
| Name | John Doe | | Name | Dave Smith | | Name | Lily Oliver | 
 -----------------   -------------------   --------------------  
| Age  | 45       | | Age  | 34         | | Age  | 55          | 
 -----------------   -------------------   --------------------  
```

## distributed

```
 -----------   -----------   ----------- 
| Port 2379 | | Port 2379 | | Port 2379 |
| ETCD      | | ETCD      | | ETCD      |
 -----------   -----------   ----------- 
```

* 3개의 ETCD Server 가 모두 실행 중이고 Database 의 동일한 복사본을 유지한다
* 하나가 다운되더라도 2개의 Server 가 실행되고 있다

### Consistent

```
 Read/Write    Read/Write    Read/Write
 -----------   -----------   ----------- 
| Port 2379 | | Port 2379 | | Port 2379 |
| ETCD      | | ETCD      | | ETCD      |
 -----------   -----------   ----------- 
```

* 어떤 instance 에서든 Write Read 가 발생한다
* 동일한 복사본이 모든 instance 에서 동시에 사용 가능하도록 보장한다

### READ

```
 Read          Read          Read
 -----------   -----------   ----------- 
| Port 2379 | | Port 2379 | | Port 2379 |
| ETCD      | | ETCD      | | ETCD      |
 -----------   -----------   ----------- 
```

* 동일한 Data 를 가지고 있기 때문에 어떤 Node 에서든 쉽게 읽을 수 있다

### WRITE

```
 Write                       Write
 -----------   -----------   ----------- 
| Port 2379 | | Port 2379 | | Port 2379 |
| ETCD      | | ETCD      | | ETCD      |
 -----------   -----------   ----------- 
```

* Write 의 경우 2개의 요청이 2개의 instance 에서 들어온다고 가정한다

```
 -------------                 -------------  
| Name | Jhon |               | Name | Joe  | 
 -------------                 -------------  
 Write                         Write
 -----------     -----------   ----------- 
| Port 2379 |   | Port 2379 | | Port 2379 |
| ETCD      |   | ETCD      | | ETCD      |
 -----------     -----------   ----------- 
```

* ETCD 는 모든 Node 에서 Write 를 처리하는 것이 아니다
* 하나의 instance 만 Write 를 처리한다

```
                               -------------  
                              | Name | Joe  | 
                               -------------  
 Write                         Write          
 -----------     -----------   -----------    
| Port 2379 |   | Port 2379 | | Port 2379 |   
| ETCD      |   | ETCD      | | ETCD      |   
 -----------     -----------   -----------    
 -------------                                
| Name | Jhon |                               
 -------------                                
```

* 내부에서 두 Node 가 선출하는 Leader 는 하나
* 전체 instance 에서 Node 하나는 Leader 가 되고 다른 노드는 Fallower 가 됩니다

```
                                 -------------  
                                | Name | Joe  | 
                                 -------------  
 Write                           Write          
 -----------     -----------     -----------    
| Port 2379 |   | Port 2379 |   | Port 2379 |   
| ETCD      |   | ETCD      |   | ETCD      |   
 -----------     -----------     -----------    
 -------------   -------------   -------------  
| Name | Jhon | | Name | Jhon | | Name | Jhon | 
 -------------   -------------   -------------  
```

* Leader 가 아닌 다른 Node 에 Write 요청이 오면 Leader 에게 Write 요청이 전달되어 처리합니다

```
 -------------                   -------------  
| Name | Joe  |<----------------| Name | Joe  | 
 -------------                   -------------  
 Write                           Write          
 -----------     -----------     -----------    
| Port 2379 |   | Port 2379 |   | Port 2379 |   
| ETCD      |   | ETCD      |   | ETCD      |   
 -----------     -----------     -----------    
 -------------   -------------   -------------  
| Name | Jhon | | Name | Jhon | | Name | Jhon | 
 -------------   -------------   -------------  
```

```
 Write                           Write          
 -----------     -----------     -----------    
| Port 2379 |   | Port 2379 |   | Port 2379 |   
| ETCD      |   | ETCD      |   | ETCD      |   
 -----------     -----------     -----------    
 ------------    -------------   -------------  
| Name | Joe |  | Name | Jhon | | Name | Jhon | 
 ------------    -------------   -------------  
```

```
 Write                           Write          
 -----------     -----------     -----------    
| Port 2379 |   | Port 2379 |   | Port 2379 |   
| ETCD      |   | ETCD      |   | ETCD      |   
 -----------     -----------     -----------    
 ------------    ------------    ------------  
| Name | Joe |  | Name | Joe |  | Name | Joe | 
 ------------    ------------    ------------  
```